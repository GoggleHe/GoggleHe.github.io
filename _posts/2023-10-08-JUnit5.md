---
layout: post
title: JUnit5å…¥é—¨æ¡ˆä¾‹
categories: [Blog]
description: JUnit5å…¥é—¨æ¡ˆä¾‹
keywords: JUnit5, å•å…ƒæµ‹è¯•
---

## JUnit5

### mavenä¾èµ–

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.junit</groupId>
            <artifactId>junit-bom</artifactId>
            <version>5.10.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependencies>
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### ç¼–å†™å•æµ‹

#### æ ‡å‡†æ¡ˆä¾‹

```java
import org.junit.jupiter.api.*;

import static org.junit.jupiter.api.Assertions.fail;

class StandardTests {
    @BeforeAll
    static void initAll() {
    }

    @BeforeEach
    void init() {
    }

    @Test
    void succeedingTest() {
    }

    @Test
    void failingTest() {
        fail("a failing test");
    }

    @Test
    @Disabled("for demonstration purposes")
    void skippedTest() {
        // not executed
    }

    @AfterEach
    void tearDown() {
    }

    @AfterAll
    static void tearDownAll() {
    }
```

#### DiaplayName

```java
package org.example.unittest;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

@DisplayName("A special test case")
class DisplayNameDemo {
    @Test
    @DisplayName("Custom test name containing spaces")
    void testWithDisplayNameContainingSpaces() {
    }

    @Test
    @DisplayName("â•¯Â°â–¡Â°ï¼‰â•¯")
    void testWithDisplayNameContainingSpecialCharacters() {
    }

    @Test
    @DisplayName("ğŸ˜±")
    void testWithDisplayNameContainingEmoji() {
    }
}

```

#### æ–­è¨€

```java
package org.example.unittest;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;

class AssertionsDemo {
    @Test
    void standardAssertions() {
        assertEquals(2, 2);
        assertEquals(4, 4, "The optional assertion message is now the last parameter.");
        assertTrue(2 == 2, () -> "Assertion messages can be lazily evaluated -- "
                + "to avoid constructing complex messages unnecessarily.");
    }

    @Test
    void groupedAssertions() {
        // In a grouped assertion all assertions are executed, and any
        // failures will be reported together.
        assertAll("address",
                () -> assertEquals("John", "John"),
                () -> assertEquals("User", "User")
        );
    }

    @Test
    void exceptionTesting() {
        Throwable exception = assertThrows(IllegalArgumentException.class, () -> {
            throw new IllegalArgumentException("a message");
        });
        assertEquals("a message", exception.getMessage());
    }
}

```

#### å‡è®¾

- `assumeTrue`
  - æ¡ä»¶æˆç«‹ï¼Œæ‰§è¡Œç¬¬äºŒä¸ªå‚æ•°é€»è¾‘
  - æ¡ä»¶ä¸æˆç«‹ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œåç»­ä»£ç ä¸æ‰§è¡Œï¼›
- `assumingThat` 
  - æ¡ä»¶æˆç«‹æ‰§è¡Œç¬¬äºŒä¸ªå‚æ•°é€»è¾‘ï¼›
  - æ— è®ºæ¡ä»¶æ˜¯å¦æˆç«‹éƒ½ä¸å½±å“åç»­ä»£ç æ‰§è¡Œ
- `System.getenv("ENV")`
  - è·å–ç¯å¢ƒå˜é‡ä¸­keyä¸ºENVçš„å˜é‡å€¼
- `System.getProperty`
  - è·å–JVMå¯åŠ¨å‚æ•°
    - -Dè®¾ç½®çš„å‚æ•°

```java
package org.example.unittest;

import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assumptions.assumeTrue;
import static org.junit.jupiter.api.Assumptions.assumingThat;

class AssumptionsDemo {
    @Test
    void testOnlyOnCiServer() {
        assumeTrue("CI".equals(System.getenv("ENV")));
        // remainder of test
    }

    @Test
    void testOnlyOnDeveloperWorkstation() {
        assumeTrue("DEV".equals(System.getenv("ENV")),
                () -> "Aborting test: not on developer workstation");
        // remainder of test
    }

    @Test
    void testInAllEnvironments() {
        assumingThat("CI".equals(System.getenv("ENV")),
                () -> {
                    // perform these assertions only on the CI server
                    assertEquals(2, 2);
                });

        // perform these assertions in all environments
        assertEquals("a string", "a string");
        System.out.println(System.getenv("JAVA_HOME"));
    }
}

```

#### ç¦ç”¨æµ‹è¯•

```java
@Disabled
class DisabledClassDemo {
    @Test
    void testWillBeSkipped() {
    }
}
```



#### æ ‡ç­¾

```java
package org.example.unittest;

import org.junit.jupiter.api.Tag;
import org.junit.jupiter.api.Test;

@Tag("fast")
@Tag("model")
class TaggingDemo {

    @Test
    @Tag("taxes")
    void testingTaxCalculation() {
    }

}

```

- å½“å‰ç”¨ä¸ä¸Šï¼Œåç»­ç« èŠ‚å‰ç½®

 #### åµŒå¥—æµ‹è¯•

```java
package org.example.unittest;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;

import java.util.EmptyStackException;
import java.util.Stack;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("A stack")
class TestingAStackDemo {

    Stack<Object> stack;

    @Test
    @DisplayName("is instantiated with new Stack()")
    void isInstantiatedWithNew() {
        new Stack<>();
    }

    @Nested
    @DisplayName("when new")
    class WhenNew {

        @BeforeEach
        void createNewStack() {
            stack = new Stack<>();
        }

        @Test
        @DisplayName("is empty")
        void isEmpty() {
            assertTrue(stack.isEmpty());
        }

        @Test
        @DisplayName("throws EmptyStackException when popped")
        void throwsExceptionWhenPopped() {
            assertThrows(EmptyStackException.class, () -> stack.pop());
        }

        @Test
        @DisplayName("throws EmptyStackException when peeked")
        void throwsExceptionWhenPeeked() {
            assertThrows(EmptyStackException.class, () -> stack.peek());
        }

        @Nested
        @DisplayName("after pushing an element")
        class AfterPushing {

            String anElement = "an element";

            @BeforeEach
            void pushAnElement() {
                stack.push(anElement);
            }

            @Test
            @DisplayName("it is no longer empty")
            void isEmpty() {
                assertFalse(stack.isEmpty());
            }

            @Test
            @DisplayName("returns the element when popped and is empty")
            void returnElementWhenPopped() {
                assertEquals(anElement, stack.pop());
                assertTrue(stack.isEmpty());
            }

            @Test
            @DisplayName("returns the element when peeked but remains not empty")
            void returnElementWhenPeeked() {
                assertEquals(anElement, stack.peek());
                assertFalse(stack.isEmpty());
            }
        }
    }
}

```

- ç”¨ä½œåç»­å­é€»è¾‘ï¼Œå¦‚æ–°å¢æ ˆåä½¿ç”¨æ–°å¢çš„æ ˆå¯¹è±¡ä½œæµ‹è¯•

#### TestInfoå’ŒTestReporter

```java
package org.example.unittest;

import org.junit.jupiter.api.*;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;

class TestInfoDemo {

    @BeforeEach
    void init(TestInfo testInfo) {
        String displayName = testInfo.getDisplayName();
        assertTrue(displayName.equals("TEST 1") || displayName.equals("test2()"));
    }

    @Test
    @DisplayName("TEST 1")
    @Tag("tag")
    void test1(TestInfo testInfo) {
        assertEquals("TEST 1", testInfo.getDisplayName());
        assertTrue(testInfo.getTags().contains("tag"));
    }

    @Test
    void test2() {
    }

}

```

```java
package org.example.unittest;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestReporter;

import java.util.HashMap;

class TestReporterDemo {

    @Test
    void reportSingleValue(TestReporter testReporter) {
        testReporter.publishEntry("a key", "a value");
    }

    @Test
    void reportSeveralValues(TestReporter testReporter) {
        HashMap<String, String> values = new HashMap<>();
        values.put("user name", "dk38");
        values.put("award year", "1974");

        testReporter.publishEntry(values);
    }

}
```

#### æµ‹è¯•æ¥å£é»˜è®¤æ–¹æ³•

- **JUnit Jupiter**å…è®¸å°†**@Test**ã€**@RepeatedTest**ã€**@ParameterizedTest**ã€**@TestFactory**ã€**TestTemplate**ã€**@BeforeEach**å’Œ**@AfterEach**æ³¨è§£å£°æ˜åœ¨æ¥â¼çš„**default**â½…æ³•ä¸Šã€‚*å¦‚æœ* æµ‹è¯•æ¥â¼æˆ–æµ‹è¯•ç±»ä½¿â½¤äº†**@TestInstance(Lifecycle.PER_CLASS)**æ³¨è§£ï¼ˆè¯·å‚é˜… ï¼‰ï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•æ¥â¼ä¸­çš„**static**â½…æ³•æˆ–æ¥â¼çš„**default**â½…æ³•ä¸Šå£°æ˜**@BeforeAll**å’Œ**@AfterAll**ã€‚å¯ä»¥åœ¨æµ‹è¯•æ¥â¼ä¸Šå£°æ˜**@ExtendWith**å’Œ**@Tag**ï¼Œä»¥ä¾¿å®ç°äº†è¯¥æ¥â¼çš„ç±»â¾ƒåŠ¨ç»§æ‰¿å®ƒçš„**tags**å’Œæ‰©å±•ã€‚
- JUnit5ç”¨æˆ·æ–‡æ¡£æä¾›äº†æ¡ˆä¾‹ï¼Œä½†æœ¬äººç›®å‰æ²¡è·‘é€š

#### åŠ¨æ€æµ‹è¯•

- ä¸€ä¸ªæµ‹è¯•æ–¹æ³•æ‰¹é‡æµ‹è¯•å¤šä¸ªç”¨ä¾‹

```java
package org.example.unittest;

import org.junit.jupiter.api.DynamicNode;
import org.junit.jupiter.api.DynamicTest;
import org.junit.jupiter.api.TestFactory;
import org.junit.jupiter.api.function.ThrowingConsumer;

import java.util.*;
import java.util.function.Function;
import java.util.stream.IntStream;
import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.*;
import static org.junit.jupiter.api.DynamicContainer.dynamicContainer;
import static org.junit.jupiter.api.DynamicTest.dynamicTest;

class DynamicTestsDemo {
    private final Calculator calculator = new Calculator();

    // This will result in a JUnitException!
    // é”™è¯¯æ¡ˆä¾‹
    @TestFactory
    List<String> dynamicTestsWithInvalidReturnType() {
        return Arrays.asList("Hello");
    }

    @TestFactory
    Collection<DynamicTest> dynamicTestsFromCollection() {
        return Arrays.asList(
                dynamicTest("1st dynamic test", () -> assertTrue(isPalindrome("madam"))),
                dynamicTest("2nd dynamic test", () -> assertEquals(4, calculator.multiply(2, 2)))
        );
    }

    @TestFactory
    Iterable<DynamicTest> dynamicTestsFromIterable() {
        return Arrays.asList(
                dynamicTest("3rd dynamic test", () -> assertTrue(isPalindrome("madam"))),
                dynamicTest("4th dynamic test", () -> assertEquals(4, calculator.multiply(2, 2)))
        );
    }

    @TestFactory
    Iterator<DynamicTest> dynamicTestsFromIterator() {
        return Arrays.asList(
                dynamicTest("5th dynamic test", () -> assertTrue(isPalindrome("madam"))),
                dynamicTest("6th dynamic test", () -> assertEquals(4, calculator.multiply(2, 2)))
        ).iterator();
    }

    @TestFactory
    DynamicTest[] dynamicTestsFromArray() {
        return new DynamicTest[]{
                dynamicTest("7th dynamic test", () -> assertTrue(isPalindrome("madam"))),
                dynamicTest("8th dynamic test", () -> assertEquals(4, calculator.multiply(2, 2)))
        };
    }

    @TestFactory
    Stream<DynamicTest> dynamicTestsFromStream() {
        return Stream.of("racecar", "radar", "mom", "dad")
                .map(text -> dynamicTest(text, () -> assertTrue(isPalindrome(text))));
    }

    @TestFactory
    Stream<DynamicTest> dynamicTestsFromIntStream() {
// Generates tests for the first 10 even integers.
        return IntStream.iterate(0, n -> n + 2).limit(10)
                .mapToObj(n -> dynamicTest("test" + n, () -> assertTrue(n % 2 == 0)));
    }

    @TestFactory
    Stream<DynamicTest> generateRandomNumberOfTests() {
// Generates random positive integers between 0 and 100 until
// a number evenly divisible by 7 is encountered.
        Iterator<Integer> inputGenerator = new Iterator<Integer>() {
            Random random = new Random();
            int current;

            @Override
            public boolean hasNext() {
                current = random.nextInt(100);
                return current % 7 != 0;
            }

            @Override
            public Integer next() {
                return current;
            }
        };
// Generates display names like: input:5, input:37, input:85, etc.
        Function<Integer, String> displayNameGenerator = (input) -> "input:" + input;
// Executes tests based on the current input value.
        ThrowingConsumer<Integer> testExecutor = (input) -> assertTrue(input % 7 != 0);
// Returns a stream of dynamic tests.
        return DynamicTest.stream(inputGenerator, displayNameGenerator, testExecutor);
    }

    @TestFactory
    Stream<DynamicNode> dynamicTestsWithContainers() {
        return Stream.of("A", "B", "C")
                .map(input -> dynamicContainer("Container " + input, Stream.of(
                        dynamicTest("not null", () -> assertNotNull(input)),
                        dynamicContainer("properties", Stream.of(
                                dynamicTest("length > 0", () -> assertTrue(input.length() > 0)),
                                dynamicTest("not empty", () -> assertFalse(input.isEmpty()))
                        ))
                )));
    }

    @TestFactory
    DynamicNode dynamicNodeSingleTest() {
        return dynamicTest("'pop' is a palindrome", () -> assertTrue(isPalindrome("pop")));
    }

    @TestFactory
    DynamicNode dynamicNodeSingleContainer() {
        return dynamicContainer("palindromes",
                Stream.of("racecar", "radar", "mom", "dad")
                        .map(text -> dynamicTest(text, () -> assertTrue(isPalindrome(text)))
                        ));
    }

    public static boolean isPalindrome(String str) {
        //test for end of recursion
        if (str.length() < 2) {
            return true;
        }

        //check first and last character for equality
        if (str.charAt(0) != str.charAt(str.length() - 1)) {
            return false;
        }

        //recursion call
        return isPalindrome(str.substring(1, str.length() - 1));
    }
}

```

#### é‡å¤æµ‹è¯•

```java
package org.example.unittest;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.RepeatedTest;
import org.junit.jupiter.api.RepetitionInfo;
import org.junit.jupiter.api.TestInfo;

import static org.junit.jupiter.api.Assertions.assertEquals;

public class RepeatedTestDemo {
    @RepeatedTest(2)
    void repeatedTestWithRepetitionInfo(RepetitionInfo repetitionInfo) {
        assertEquals(2, repetitionInfo.getTotalRepetitions());
    }

    @RepeatedTest(value = 1, name = "{displayName} {currentRepetition}/{totalRepetitions}")
    @DisplayName("Repeat!")
    void customDisplayName(TestInfo testInfo) {
        assertEquals(testInfo.getDisplayName(), "Repeat! 1/1");
    }

    @RepeatedTest(value = 1, name = RepeatedTest.LONG_DISPLAY_NAME)
    @DisplayName("Details...")
    void customDisplayNameWithLongPattern(TestInfo testInfo) {
        assertEquals(testInfo.getDisplayName(), "Details... :: repetition 1 of 1");
    }

    @RepeatedTest(value = 2, name = "Wiederholung {currentRepetition} von {totalRepetitions}")
    void repeatedTestInGerman() {
// ...
    }
}

```

#### æµ‹è¯•æ‰§è¡Œé¡ºåº

```java
package org.example.unittest;

import org.junit.jupiter.api.MethodOrderer;
import org.junit.jupiter.api.Order;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestMethodOrder;

@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
class OrderedTestsDemo {
    @Test
    @Order(1)
    void nullValues() {
        // perform assertions against null values
        System.out.println(1);
    }

    @Test
    @Order(2)
    void emptyValues() {
        // perform assertions against empty values
        System.out.println(2);
    }

    @Test
    @Order(3)
    void validValues() {
        // perform assertions against valid values
        System.out.println(3);
    }
}

```

- åŒ…æ‹¬æ³¨è§£æ’åºã€éšæœºæ’åºã€æ–¹æ³•åæ’åºã€DisplayNameæ’åº
- `@TestClassOrder`ç»“åˆ`ClassOrderer.OrderAnnotation`ç±»ï¼Œå®šä¹‰åµŒå¥—æµ‹è¯•ç±»é¡ºåº

### å‚æ•°åŒ–æµ‹è¯•

```java
package org.example.unittest;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.TestReporter;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;
import org.junit.jupiter.params.provider.ValueSource;

import static org.junit.jupiter.api.Assertions.*;

class NumberHelperTest {

    @ParameterizedTest
    @ValueSource(ints = {1, 2, 3, 4, 5})
    void testIsPositiveTrue(Integer value) {
        assertTrue(NumberHelper.isPositive(value), value + " is not positive");
    }

    @ParameterizedTest
    @ValueSource(ints = {0, -1, -3, -4, -5})
    void testIsPositiveFalse(Integer value) {
        assertFalse(NumberHelper.isPositive(value), value + " is positive");
    }

    @DisplayName("test is positive number")
    @ParameterizedTest(name = "actual {0}, expected {1}")
    @CsvSource({"1,true", "-2,false", "3,true", "-4,false", "0,false", "6,true"})
    void testCsvIsPositiveFalse(Integer value, Boolean expected, TestReporter testReporter) {
        assertEquals(expected, NumberHelper.isPositive(value));
        testReporter.publishEntry("hello", "world");
    }
}
```

#### å‚æ•°æº

- `@ValueSource` `@NullSource` `@EmptySource` `@NullAndEmptySource` 

```java
@ParameterizedTest
@NullSource
@EmptySource
@ValueSource(strings = { " ", " ", "\t", "\n" })
void nullEmptyAndBlankStrings(String text) {
	assertTrue(text == null || text.trim().isEmpty());
}
```

- `@EnumSource`

```java
class EnumSourceDemo {
    @ParameterizedTest
    @EnumSource(value = TimeUnit.class, names = {"DAYS", "HOURS"})
    void testWithEnumSourceInclude(TimeUnit timeUnit) {
        assertTrue(EnumSet.of(TimeUnit.DAYS, TimeUnit.HOURS).contains(timeUnit));
    }

    //modeåŒ¹é…
    @ParameterizedTest
    @EnumSource(value = TimeUnit.class, mode = EXCLUDE, names = {"DAYS", "HOURS"})
    void testWithEnumSourceExclude(TimeUnit timeUnit) {
        assertFalse(EnumSet.of(TimeUnit.DAYS, TimeUnit.HOURS).contains(timeUnit));
        assertTrue(timeUnit.name().length() > 5);
    }

    //modeåŒ¹é…
    @ParameterizedTest
    @EnumSource(value = TimeUnit.class, mode = MATCH_ALL, names = "^(M|N).+SECONDS$")
    void testWithEnumSourceRegex(TimeUnit timeUnit) {
        String name = timeUnit.name();
        assertTrue(name.startsWith("M") || name.startsWith("N"));
        assertTrue(name.endsWith("SECONDS"));
    }
}
```

- `@MethodSource`

```java
package org.example.unittest;

import org.junit.jupiter.api.Nested;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.MethodSource;

import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.assertNotNull;

class ParameterizedTestDemo {

    @Nested
    class MethodSourceDemo {
       //é»˜è®¤æœç´¢ä¸å½“å‰æ–¹æ³•åŒåçš„å·¥å‚æ–¹æ³•
        @ParameterizedTest
        @MethodSource("org.example.unittest.ParameterizedTestDemo#stringProvider")
        void testWithSimpleMethodSource(String argument) {
            assertNotNull(argument);
        }

        //å¤šå‚æ•°ç¤ºä¾‹
        @ParameterizedTest
        @MethodSource("org.example.unittest.ParameterizedTestDemo#stringIntAndListProvider")
        void testWithMultiArgMethodSource(String str, int num, List<String> list) {
            assertEquals(3, str.length());
            assertTrue(num >= 1 && num <= 2);
            assertEquals(2, list.size());
        }
    }

    static Stream<String> stringProvider() {
        return Stream.of("foo", "bar");
    }
    
    static Stream<Arguments> stringIntAndListProvider() {
        return Stream.of(
                Arguments.of("foo", 1, Arrays.asList("a", "b")),
                Arguments.of("bar", 2, Arrays.asList("x", "y"))
        );
    }

}
```

- `@CvsSource`

```java
class CsvSourceDemo {
    @ParameterizedTest
    @CsvSource({"foo, 1", "bar, 2", "'baz, qux', 3", ",4"})
    void testWithCsvSource(String first, int second) {
        assertNotNull(first);
        assertNotEquals(0, second);
    }
}
```

- `@CsvFileSource`

```java
class CsvFileSourceDemo {
    @ParameterizedTest
    @CsvFileSource(resources = "/two-column.csv")
    void testWithCsvFileSource(String first, int second) {
        assertNotNull(first);
        assertNotEquals(0, second);
    }
}
```

- `@ArgumentsSource`

```java
class ArgumentsSourceDemo {
    @ParameterizedTest
    @ArgumentsSource(MyArgumentsProvider.class)
    void testWithArgumentsSource(String argument) {
        assertNotNull(argument);
    }
}

static class MyArgumentsProvider implements ArgumentsProvider {
    @Override
    public Stream<? extends Arguments> provideArguments(ExtensionContext context) {
        return Stream.of("apple", "banana").map(Arguments::of);
    }
}
```

#### å‚æ•°è½¬æ¢

```java
class ParamCovertDemo {
    @ParameterizedTest
    @EnumSource(TimeUnit.class)
    void testWithExplicitArgumentConversion(@ConvertWith(ToStringArgumentConverter.class) String argument) {
        assertNotNull(TimeUnit.valueOf(argument));
    }
    
    @ParameterizedTest
    @ValueSource(strings = {"01.01.2017", "31.12.2017"})
    void testWithExplicitJavaTimeConverter(@JavaTimeConversionPattern("dd.MM.yyyy") LocalDate argument) {
        assertEquals(2017, argument.getYear());
    }
}

static class ToStringArgumentConverter extends SimpleArgumentConverter {
    @Override
    protected Object convert(Object source, Class<?> targetType) {
        assertEquals(String.class, targetType, "Can only convert to String");
        return String.valueOf(source);
    }
}
```

#### å‚æ•°èšåˆ

- å‚æ•°è®¿é—®å™¨
- è‡ªå®šä¹‰èšåˆ

```java
class ArgumentsAccessorDemo {
    //å‚æ•°è®¿é—®å™¨
    @ParameterizedTest
    @CsvSource({
        "Jane, Doe, F, 1990-05-20",
        "John, Doe, M, 1990-10-22"
    })
    void testWithArgumentsAccessor(ArgumentsAccessor arguments) {
        Person person = new Person(arguments.getString(0),
                                   arguments.getString(1),
                                   arguments.get(2, Gender.class),
                                   arguments.get(3, LocalDate.class));
        if (person.getFirstName().equals("Jane")) {
            assertEquals(Gender.F, person.getGender());
        } else {
            assertEquals(Gender.M, person.getGender());
        }
        assertEquals("Doe", person.getLastName());
        assertEquals(1990, person.getDateOfBirth().getYear());
    }

    //è‡ªå®šä¹‰èšåˆ
    @ParameterizedTest
    @CsvSource({
        "Jane, Doe, F, 1990-05-20",
        "John, Doe, M, 1990-10-22"
    })
    void testWithArgumentsAggregator(@AggregateWith(PersonAggregator.class) Person person) {
        assertEquals("Doe", person.getLastName());
        assertEquals(1990, person.getDateOfBirth().getYear());
    }
}
```

```java
package org.example.unittest;

import org.junit.jupiter.api.extension.ParameterContext;
import org.junit.jupiter.params.aggregator.ArgumentsAccessor;
import org.junit.jupiter.params.aggregator.ArgumentsAggregator;

import java.time.LocalDate;

public class PersonAggregator implements ArgumentsAggregator {
    @Override
    public Person aggregateArguments(ArgumentsAccessor arguments, ParameterContext context) {
        return new Person(arguments.getString(0),
                arguments.getString(1),
                arguments.get(2, Gender.class),
                arguments.get(3, LocalDate.class));
    }
}
```

- ç”¨ä¸€ä¸ªæ³¨è§£æ›¿ä»£`@AggregateWith(PersonAggregator.class)`

```java
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.PARAMETER)
@AggregateWith(PersonAggregator.class)
public @interface CsvToPerson {
}
```

- è‡ªå®šä¹‰æ˜¾ç¤ºåç§°

```java
//è‡ªå®šä¹‰æ˜¾ç¤ºåç§°
@DisplayName("Display name of container")
@ParameterizedTest(name = "{index} ==> fruit=''{0}'', rank={1}")
@CsvSource({"apple, 1", "banana, 2", "'lemon, lime', 3"})
void testWithCustomDisplayNames(String fruit, int rank) {
}
```

#### ä¸å†…ç½®å‚æ•°è§£ææ‰©å±•æ··ç”¨

- å‚æ•°æºå’Œå•æµ‹æŠ¥å‘Šçš„æ··ç”¨ï¼ŒTestReporterç­‰éœ€åœ¨æœ€å

```java
//â½£å‘½å‘¨æœŸå’Œäº’é€šæ€§
@ParameterizedTest
@ValueSource(strings = "foo")
void testWithRegularParameterResolver(String argument, TestReporter testReporter) {
    testReporter.publishEntry("argument", argument);
}
```

#### 

### æ‰©å±•æ¨¡å‹

#### æ³¨å†Œæ‰©å±•

##### æ³¨è§£æ³¨å†Œ

- ç±»ä¸Šæ³¨å†Œ
- æ–¹æ³•ä¸Šæ³¨å†Œ
- æ³¨å†Œå¤šä¸ª

```java
@ExtendWith(TimingExtension.class)
@ExtendWith({MockitoExtension.class})
class RegisterExtension {
    @ExtendWith({MockitoExtension.class})
    @Test
    void mockTest() {
        // ...
    }

    @Test
    @ExtendWith({FooExtension.class, BarExtension.class})
    void extensionTest() {

    }
}
```

##### ç¼–ç¨‹æ³¨å†Œ

```java
public class ExtensionDemo {

    @RegisterExtension
    static TimingExtension extension = new TimingExtension();

    @Test
    void test1() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("Test 1");

    }
}
```

- `@RegisterExtension`å¦‚æœç”¨åœ¨éé™æ€å­—æ®µä¸Šï¼Œç”±äºJUnité»˜è®¤ç”Ÿå‘½å‘¨æœŸä¸ºæ–¹æ³•çº§åˆ«ï¼Œæ­¤æ—¶è¢«æ³¨å†Œçš„æ‰©å±•å¦‚æœæ˜¯**BeforeAllCallback**ã€**AfterAllCallback**æˆ–**TestInstancePostProcessor**ç­‰ç±»çº§åˆ«çš„æ‰©å±•ï¼Œæ³¨å…¥çš„æ‰©å±•å°†ä¸èƒ½æ­£å¸¸å·¥ä½œ

##### è‡ªåŠ¨æ³¨å†Œ

- å¼€å¯è‡ªåŠ¨æ³¨å†Œå¼€å…³
  - å¯åŠ¨å‚æ•°ï¼š**-Djunit.jupiter.extensions.autodetection.enabled=true**
  - é…ç½®junit-platform.propertiesæ–‡ä»¶ï¼šæ·»åŠ **junit.jupiter.extensions.autodetection.enabled=true**
- resources/WEB-INF/servicesç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶**org.junit.jupiter.api.extension.Extension**
  - å†…å®¹éœ€è¦æ³¨å†Œæ‰©å±•çš„å…¨ç±»å
- æ²¡è·‘é€šï¼Œä½¿ç”¨åœºæ™¯æœ‰é™ï¼Œç¢°åˆ°å†ç ”ç©¶

#### æ¡ä»¶æµ‹è¯•

- åœç”¨æ¡ä»¶æµ‹è¯•

  - -Djunit.conditions.deactivate=org.junit.*DisabledCondition åœç”¨@Disable

- æ¨¡å¼åŒ¹é…è¯­æ³•

  - `*`: åœç”¨æ‰€æœ‰æ¡ä»¶
  - `org.junit.*`: åœç”¨ `org.junit` åŒ…åŠå…¶å­åŒ…ä¸‹çš„æ‰€æœ‰æ¡ä»¶
  - `*.MyCondition`: åœç”¨ç®€å•ç±»åä¸ºä¸º `MyCondition`çš„æ¡ä»¶
  - `*System*`: deactivates every condition whose simple class name contains `System`.
  - `org.example.MyCondition`: åœç”¨å…¨ç±»åä¸º `org.example.MyCondition`çš„æ¡ä»¶

- JUnit5éœ€è¦å‡çº§maven-surefire-pluginæ’ä»¶2.22.0 or higher

- å¸¸ç”¨æ³¨è§£

  - Javaç¯å¢ƒ

    - `@EnabledOnJre`ï¼šæŒ‡å®šå¤šä¸ª JRE ç‰ˆæœ¬ï¼Œåªæœ‰å½“å‰æµ‹è¯•ç¯å¢ƒ JRE ç‰ˆæœ¬åœ¨æ­¤èŒƒå›´å†…æ‰æ‰§è¡Œæµ‹è¯•ã€‚
    - `@DisabledOnJre`ï¼šæŒ‡å®šå¤šä¸ª JRE ç‰ˆæœ¬ï¼Œåªæœ‰å½“å‰æµ‹è¯•ç¯å¢ƒ JRE ç‰ˆæœ¬ä¸åœ¨æ­¤èŒƒå›´å†…æ‰æ‰§è¡Œæµ‹è¯•ã€‚`
    - `@EnabledForJreRange`ï¼šæŒ‡å®šä¸€ä¸ª JRE ç‰ˆæœ¬èŒƒå›´ï¼Œåªæœ‰å½“å‰æµ‹è¯•ç¯å¢ƒ JRE ç‰ˆæœ¬åœ¨æ­¤èŒƒå›´å†…æ‰æ‰§è¡Œæµ‹è¯•ã€‚
    - `@DisabledForJreRange`ï¼šæŒ‡å®šä¸€ä¸ª JRE ç‰ˆæœ¬èŒƒå›´ï¼Œåªæœ‰å½“å‰æµ‹è¯•ç¯å¢ƒ JRE ç‰ˆæœ¬ä¸åœ¨æ­¤èŒƒå›´å†…æ‰æ‰§è¡Œæµ‹è¯•ã€‚

  - OSç¯å¢ƒ

    - `EnabledOnOs`ï¼šå½“å‰ç³»ç»Ÿä¸ºæŒ‡å®šæ“ä½œç³»ç»Ÿæ—¶æ‰§è¡Œæµ‹è¯•ã€‚
    - `DisabledOnOs`ï¼šå½“å‰ç³»ç»Ÿä¸ºæŒ‡å®šæ“ä½œç³»ç»Ÿæ—¶ä¸æ‰§è¡Œæµ‹è¯•ã€‚

  - ç³»ç»Ÿå±æ€§

    - `@EnabledIfSystemProperty`ï¼šå½“å‰ç³»ç»ŸåŒ¹é…æŒ‡å®šçš„ç³»ç»Ÿå±æ€§åç§°å’ŒæœŸæœ›å€¼æ—¶æ‰§è¡Œæµ‹è¯•ã€‚
    - `@DisabledIfSystemProperty`ï¼šå½“å‰ç³»ç»ŸåŒ¹é…åˆ¶å®šçš„ç³»ç»Ÿå±æ€§åç§°å’ŒæœŸæœ›å€¼æ—¶ä¸æ‰§è¡Œæµ‹è¯•ã€‚

  - ç¯å¢ƒå˜é‡

    - `EnabledIfEnvironmentVariable`ï¼šå½“å‰ç³»ç»ŸåŒ¹é…æŒ‡å®šçš„ç¯å¢ƒå˜é‡åç§°å’ŒæœŸæœ›å€¼æ—¶æ‰§è¡Œæµ‹è¯•ã€‚
    - `DisabledIfEnvironmentVariable`ï¼šå½“å‰ç³»ç»ŸåŒ¹é…åˆ¶å®šçš„ç¯å¢ƒå˜é‡åç§°å’ŒæœŸæœ›å€¼æ—¶ä¸æ‰§è¡Œæµ‹è¯•ã€‚

  - è‡ªå®šä¹‰

    - `@EnableIf`
    - `@DisableIf`
    - è‹¥æ¡ä»¶æ–¹æ³•ä¸å†æœ¬ç±»ä¸­ï¼Œéœ€ç”¨å…¨ç±»å

    ```java
    class Custom{
            @Test
            @EnabledIf("customCondition")
            public void enabledIf() {
                System.out.println("Method[enabledIf] executed.");
            }
    
            @Test
            @DisabledIf("customCondition")
            public void disabledIf() {
                System.out.println("Method[disabledIf] executed.");
            }
    
            private boolean customCondition() {
                return true;
            }
        }
    ```

#### æµ‹è¯•å®ä¾‹é¢„æ„é€ å›è°ƒ

- `org.junit.jupiter.api.extension.TestInstancePreConstructCallback`
  - å•å…ƒæµ‹è¯•å®ä¾‹åŒ–ä¹‹å‰è°ƒç”¨

#### æµ‹è¯•å®ä¾‹å·¥å‚

- `org.junit.jupiter.api.extension.TestInstanceFactory`
  - æµ‹è¯•å®ä¾‹åˆ›å»ºå®ä¾‹æ—¶è°ƒç”¨

#### æµ‹è¯•å®ä¾‹åç½®å¤„ç†

- `TestInstancePostProcessor`:æµ‹è¯•å®ä¾‹åç½®å¤„ç†æ‰©å±•ï¼Œæµ‹è¯•å®ä¾‹åˆå§‹åŒ–åæ‰§è¡Œ

```java
class TestInstancePostProcessorDemo {

    @Test
    @ExtendWith(MyTestInstancePostProcessor.class)
    void testTestInstancePostProcessor() {
        System.out.println("test");
    }

    static class MyTestInstancePostProcessor implements TestInstancePostProcessor {

        @Override
        public void postProcessTestInstance(Object o, ExtensionContext extensionContext) throws Exception {
            System.out.println("postProcessTestInstance");
        }
    }
}
```

#### æµ‹è¯•å®ä¾‹é¢„é”€æ¯å›è°ƒ

- `org.junit.jupiter.api.extension.TestInstancePreDestroyCallback`

#### å‚æ•°è§£æå™¨

##### å†…ç½®å‚æ•°è§£æå™¨

- TestInfoParameterResolver å‚æ•°ç±»å‹ä¸ºTestInfo
- RepetitionInfoParameterResolver å‚æ•°ç±»å‹ä¸ºRepetitionInfo
- TestReporterParameterResolver å‚æ•°ç±»å‹ä¸ºTestReporter

##### è‡ªå®šä¹‰å‚æ•°è§£æå™¨

```java
class ParameterResolverDemo {

    @Test
    @ExtendWith(IntRandomParameterResolver.class)
    void injectsInteger(Integer i, Integer j) {
        System.out.println(i + "->" + j);
    }

    static class IntRandomParameterResolver implements ParameterResolver {
        @Override
        public boolean supportsParameter(ParameterContext parameterContext, ExtensionContext extensionContext) throws ParameterResolutionException {
            return parameterContext.getParameter().getType().isAssignableFrom(Integer.class);
        }

        @Override
        public Object resolveParameter(ParameterContext parameterContext, ExtensionContext extensionContext) throws ParameterResolutionException {
            boolean assignableFrom = parameterContext.getParameter().getType().isAssignableFrom(Integer.class);
            if (assignableFrom) {
                return (int) (Math.random() * 100);
            }
            return null;
        }
    }

}
```

#### æµ‹è¯•ç»“æœå¤„ç†

- TestWatcher
  - **testDisabled:** è¢«**@Disabled**æ³¨é‡Šçš„â½…æ³•è·³è¿‡å
  - **testSuccessful:** æˆåŠŸæµ‹è¯•
  - **testAborted:**æµ‹è¯•ç»ˆâ½Œ æ¦‚å¿µä¸ç†è§£
  - **testFailed:** æµ‹è¯•å¤±è´¥

```java

```

#### æµ‹è¯•ç”Ÿå‘½å‘¨æœŸå›è°ƒ

- `BeforeAllCallback`
- `BeforeEachCallback`
- `BeforeTestExecutionCallback`
- `AfterTestExecutionCallback`
- `AfterEachCallback`
- `AfterAllCallback`

#### æ‹¦æˆªè°ƒç”¨

 - `org.junit.jupiter.api.extension.InvocationInterceptor`
    - `#interceptTestClassConstructor`
    - `#interceptBeforeAllMethod`
    - `#interceptBeforeEachMethod`
    - `#interceptTestMethod`
    - `#interceptTestFactoryMethod`
    - `#interceptTestTemplateMethod`
    - `#interceptDynamicTest`
    - `#interceptAfterEachMethod`
    - `#interceptAfterAllMethod`

```java
public class MyInvocationInterceptor implements InvocationInterceptor {
    @Override
    public void interceptTestMethod(Invocation<Void> invocation,
                                    ReflectiveInvocationContext<Method> invocationContext,
                                    ExtensionContext extensionContext) throws Throwable {

        AtomicReference<Throwable> throwable = new AtomicReference<>();

        SwingUtilities.invokeAndWait(() -> {
            try {
                invocation.proceed();
            }
            catch (Throwable t) {
                throwable.set(t);
            }
        });
        Throwable t = throwable.get();
        if (t != null) {
            throw t;
        }
    }
}
```

#### å¼‚å¸¸å¤„ç†

- `TestExecutionExceptionHandler`

#### å†…ç½®æ‰©å±•`@TempDir`

```java
package org.example.unittest;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.io.CleanupMode;
import org.junit.jupiter.api.io.TempDir;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Arrays;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

public class TempDirDemo {

    @TempDir
    File file;

    @Test
    void testTempDirAnnotation(@TempDir(cleanup = CleanupMode.ALWAYS) Path tempDir)
            throws IOException {
        Path numbers = tempDir.resolve("numbers.txt");

        List<String> lines = Arrays.asList("1", "2", "3");
        Files.write(numbers, lines);
        assertAll(
                () -> assertTrue(Files.exists(numbers), "File should exist"),
                () -> assertLinesMatch(lines, Files.readAllLines(numbers)));

        File file = new File("haha.txt");
        file.createNewFile();
        assertTrue(file.exists());
    }
}

```

#### æ‰©å±•ä¸ç”¨æˆ·ä»£ç 

- éƒ¨åˆ†æ‰©å±•ç‚¹ä¸æ³¨è§£çš„æ‰§è¡Œé¡ºåº
  - org.junit.jupiter.api.extension.BeforeAllCallback
  - @BeforeAll
  - org.junit.jupiter.api.extension.BeforeEachCallback
  - @BeforeEach
  - org.junit.jupiter.api.extension.BeforeTestExecutionCallback
  - @Test
  - org.junit.jupiter.api.extension.TestExecutionExceptionHandler å¼‚å¸¸åå¤„ç†ä»£ç 
  - org.junit.jupiter.api.extension.AfterTestExecutionCallback
  - @AfterEach
  - org.junit.jupiter.api.extension.AfterEachCallback
  - @AfterAll
  - org.junit.jupiter.api.extension.AfterAllCallback
- å…¶ä»–æ‰©å±•ç‚¹
  - org.junit.jupiter.api.extension.TestInstanceFactory
  - org.junit.jupiter.api.extension.TestInstancePostProcessor
  - org.junit.jupiter.api.extension.ParameterResolver
  - org.junit.jupiter.api.extension.ConditionEvaluationResultAggregator
  - org.junit.jupiter.api.extension.TestExecutionExceptionHandler
  - org.junit.jupiter.api.extension.TestWatcher

```java
@ExtendWith(TimingExtension.class)
public class ExtensionDemo {
    @Test
    void test1() {
        System.out.println("Test 1");
    }

    @Test
    void test2() {
        System.out.println("Test 2");
    }
}
```

```java
package org.example.unittest.extension;

import org.junit.jupiter.api.extension.AfterTestExecutionCallback;
import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;
import org.junit.jupiter.api.extension.ExtensionContext;

public class TimingExtension implements BeforeTestExecutionCallback, AfterTestExecutionCallback {
    private long startTime;

    @Override
    public void beforeTestExecution(ExtensionContext extensionContext) throws Exception {
        startTime = System.currentTimeMillis();
    }

    @Override
    public void afterTestExecution(ExtensionContext extensionContext) throws Exception {
        long duration = System.currentTimeMillis() - startTime;
        System.out.println("Test took " + duration + "ms");
    }
}

```

#### æµ‹è¯•æ¨¡æ¿

```java
package org.example.unittest;

import org.junit.jupiter.api.TestTemplate;
import org.junit.jupiter.api.extension.*;

import java.util.Collections;
import java.util.List;
import java.util.UUID;
import java.util.stream.IntStream;
import java.util.stream.Stream;

class TestTemplateDemo {

    @TestTemplate
    @ExtendWith(SimpleTestTemplateExtension.class)
    void test(Integer val1, Integer val2) {
        System.out.println("value 1: " + val1 + " || value 2: " + val2);
    }

    @TestTemplate
    @ExtendWith(SimpleTestTemplateExtension.class)
    void test(Integer val1, Integer val2, String val3) {
        System.out.println("value 1: " + val1 + " || value 2: " + val2 + " || value 3: " + val3);
    }

    static class SimpleTestTemplateExtension implements TestTemplateInvocationContextProvider {
        // æ˜¯å¦æ”¯æŒè¯¥æ¨¡æ¿æ–¹æ³•ï¼Œè¿”å›falseå°†ä¸ä¼šæ‰§è¡ŒprovideTestTemplateInvocationContexts
        // (ExtensionContext context)æ–¹æ³•ï¼Œä½ å½“ç„¶å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡åšäº›é¢å¤–åˆ¤æ–­
        @Override
        public boolean supportsTestTemplate(ExtensionContext context) {
            return true;
        }

        @Override
        public Stream<TestTemplateInvocationContext>
        provideTestTemplateInvocationContexts(ExtensionContext context) {
            return IntStream.rangeClosed(1, 50) // å°†ä¼šäº§ç”Ÿ50æ¬¡å‚æ•°ï¼Œæ„å‘³ç€æ¨¡æ¿æ–¹æ³•ä¼šè¢«æ‰§è¡Œ50æ¬¡
                    .mapToObj(n -> new TestTemplateInvocationContext() { // å®ä¾‹åŒ–

                        @Override
                        public List<Extension> getAdditionalExtensions() {
                            return Collections.singletonList(new ParameterResolver() { // å®ä¾‹åŒ–
                                @Override
                                public boolean supportsParameter(ParameterContext parameterContext,
                                                                 ExtensionContext extensionContext)
                                        throws ParameterResolutionException {
                                    Class<?> type = parameterContext.getParameter().getType();
                                    // æ”¯æŒIntegerå’ŒStringç±»å‹çš„å‚æ•°
                                    return type.isAssignableFrom(Integer.class)
                                            || type.isAssignableFrom(String.class);
                                }

                                @Override // äº§ç”Ÿéšæœºæ•´æ•°
                                public Object resolveParameter(ParameterContext parameterContext,
                                                               ExtensionContext extensionContext)
                                        throws ParameterResolutionException {
                                    Class<?> type = parameterContext.getParameter().getType();
                                    if (type.isAssignableFrom(String.class)) {
                                        return UUID.randomUUID().toString();
                                    } else if (type.isAssignableFrom(Integer.class)) {
                                        return (int) (Math.random() * 100);
                                    }
                                    return null;
                                }
                            });
                        }
                    });
        }
    }
}
```

#### åœ¨æ‰©å±•ä¸­ä¿å­˜çŠ¶æ€

- `ExtensionContext`æä¾›`Store`APIæ”¯æŒè¯¥åŠŸèƒ½

#### æµ‹è¯•å®ä¾‹ç”Ÿå‘½å‘¨æœŸ

- `@TestInstance`å’Œ`TestInstance.LifeStyle`ç»™æµ‹è¯•ç±»å®šä¹‰ç”Ÿå‘½å‘¨æœŸ
  - PER_CLASS
  - PER_METHOD
- åœ¨**src/test/resources**ä¸‹æ–°å¢æ–‡ä»¶ä¸º**junit-platform.properties**ï¼Œå†™å…¥**junit.jupiter.testinstance.lifecycle.default = per_class**